(()=>{var e={};e.id=654,e.ids=[654],e.modules={846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3067:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>k,routeModule:()=>p,serverHooks:()=>f,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>d});var s={};r.r(s),r.d(s,{GET:()=>c});var n=r(6559),o=r(8088),a=r(7719),i=r(2190),u=r(3788);async function c(e){let t=await (0,u.H)();return t&&t.accessToken?i.NextResponse.json({accessToken:t.accessToken}):i.NextResponse.json({error:"Not authenticated"},{status:401})}let p=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/auth/token/route",pathname:"/api/auth/token",filename:"route",bundlePath:"app/api/auth/token/route"},resolvedPagePath:"C:\\Users\\Luke\\Downloads\\fix it\\Spotify-Widget-App\\app\\api\\auth\\token\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:l,workUnitAsyncStorage:d,serverHooks:f}=p;function k(){return(0,a.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:d})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3788:(e,t,r)=>{"use strict";r.d(t,{H:()=>a});var s=r(4999);function n(e,t){console.log(`[DEBUG] ${e}`,t||"")}function o(e,t){console.error(`[ERROR] ${e}`,t||""),t instanceof Error&&console.error(`Stack: ${t.stack}`)}async function a(){let e=await (0,s.UL)(),t=e.get("spotify_access_token"),r=e.get("spotify_refresh_token");if(!t)return n("No access token found"),null;try{let e=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${t.value}`}});if(e.ok)return{user:await e.json(),accessToken:t.value};if(401===e.status&&r){n("Access token expired, attempting to refresh");let e=await i(r.value);if(e)return{accessToken:e}}return o("Failed to validate token",{status:e.status}),null}catch(e){return o("Error validating session",e),null}}async function i(e){let t=process.env.SPOTIFY_CLIENT_ID,r=process.env.SPOTIFY_CLIENT_SECRET;if(!t||!r)return o("Missing client credentials for token refresh"),null;try{let n=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${Buffer.from(`${t}:${r}`).toString("base64")}`},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:e})});if(!n.ok)return o("Failed to refresh token",await n.text()),null;let a=await n.json(),i=await (0,s.UL)();return i.set("spotify_access_token",a.access_token,{maxAge:a.expires_in,path:"/"}),a.refresh_token&&i.set("spotify_refresh_token",a.refresh_token,{maxAge:2592e3,path:"/"}),a.access_token}catch(e){return o("Error refreshing token",e),null}}},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6487:()=>{},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[80,999,580],()=>r(3067));module.exports=s})();
(()=>{var e={};e.id=352,e.ids=[352],e.modules={317:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>m,routeModule:()=>p,serverHooks:()=>f,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>d});var n={};r.r(n),r.d(n,{GET:()=>u});var s=r(6559),a=r(8088),o=r(7719),i=r(3788),c=r(553);async function u(e){let t=await (0,i.H)();return t?new Response(new ReadableStream({start(r){let n=null,s=!1,a=0,o="",i=async()=>{try{let e=await c.spotifyApi.getCurrentPlayback(t.accessToken);if(!e||!e.item){r.enqueue(p.encode(`data: ${JSON.stringify({type:"playback",data:{is_playing:!1}})}

`));return}let o=e.item?.id||null,i=e.is_playing||!1,l=e.progress_ms||0,d=o!==n,f=i!==s,m=Math.abs(l-a)>3e3;(d||f||m)&&(r.enqueue(p.encode(`data: ${JSON.stringify({type:"playback",data:e})}

`)),n=o,s=i,a=l,d&&(u(),o&&(0,c.clearCache)(`audio-features-${o}`)))}catch(e){console.error("Error in SSE stream:",e),r.enqueue(p.encode(`data: ${JSON.stringify({type:"ping"})}

`))}},u=async()=>{try{let e=await c.spotifyApi.getQueue(t.accessToken);if(e){let t=e.queue?e.queue.map(e=>e.id).join("|"):"";t!==o&&(r.enqueue(p.encode(`data: ${JSON.stringify({type:"queue",data:e})}

`)),o=t)}}catch(e){console.error("Error fetching queue:",e)}},p=new TextEncoder;r.enqueue(p.encode(`data: ${JSON.stringify({type:"connected"})}

`)),i();let l=setInterval(i,3e3),d=setInterval(u,1e4);e.signal.addEventListener("abort",()=>{clearInterval(l),clearInterval(d)})}}),{headers:{"Content-Type":"text/event-stream","Cache-Control":"no-cache",Connection:"keep-alive"}}):new Response(JSON.stringify({error:"Unauthorized"}),{status:401,headers:{"Content-Type":"application/json"}})}let p=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/spotify/events/route",pathname:"/api/spotify/events",filename:"route",bundlePath:"app/api/spotify/events/route"},resolvedPagePath:"C:\\Users\\Luke\\Downloads\\fix it\\Spotify-Widget-App\\app\\api\\spotify\\events\\route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:l,workUnitAsyncStorage:d,serverHooks:f}=p;function m(){return(0,o.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:d})}},553:()=>{throw Error('Module build failed (from ./node_modules/next/dist/build/webpack/loaders/next-swc-loader.js):\nError:   \x1b[31mx\x1b[0m You\'re importing a component that needs `useRef`. This React hook only works in a client component. To fix, mark the file (or its parent) with the `"use client"` directive.\n  \x1b[31m|\x1b[0m \n  \x1b[31m|\x1b[0m  Learn more: https://nextjs.org/docs/app/api-reference/directives/use-client\n  \x1b[31m|\x1b[0m \n  \x1b[31m|\x1b[0m \n   ,-[\x1b[36;1;4mC:\\Users\\Luke\\Downloads\\fix it\\Spotify-Widget-App\\lib\\spotify-api.ts\x1b[0m:2:1]\n \x1b[2m1\x1b[0m | import { logDebug, logError } from "./debug";\n \x1b[2m2\x1b[0m | import { useRef } from "react";\n   : \x1b[35;1m         ^^^^^^\x1b[0m\n \x1b[2m3\x1b[0m | \n \x1b[2m4\x1b[0m | // Cache configuration\n \x1b[2m4\x1b[0m | const CACHE_TTL = {\r\n   `----\n')},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},3788:(e,t,r)=>{"use strict";r.d(t,{H:()=>o});var n=r(4999);function s(e,t){console.log(`[DEBUG] ${e}`,t||"")}function a(e,t){console.error(`[ERROR] ${e}`,t||""),t instanceof Error&&console.error(`Stack: ${t.stack}`)}async function o(){let e=await (0,n.UL)(),t=e.get("spotify_access_token"),r=e.get("spotify_refresh_token");if(!t)return s("No access token found"),null;try{let e=await fetch("https://api.spotify.com/v1/me",{headers:{Authorization:`Bearer ${t.value}`}});if(e.ok)return{user:await e.json(),accessToken:t.value};if(401===e.status&&r){s("Access token expired, attempting to refresh");let e=await i(r.value);if(e)return{accessToken:e}}return a("Failed to validate token",{status:e.status}),null}catch(e){return a("Error validating session",e),null}}async function i(e){let t=process.env.SPOTIFY_CLIENT_ID,r=process.env.SPOTIFY_CLIENT_SECRET;if(!t||!r)return a("Missing client credentials for token refresh"),null;try{let s=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:`Basic ${Buffer.from(`${t}:${r}`).toString("base64")}`},body:new URLSearchParams({grant_type:"refresh_token",refresh_token:e})});if(!s.ok)return a("Failed to refresh token",await s.text()),null;let o=await s.json(),i=await (0,n.UL)();return i.set("spotify_access_token",o.access_token,{maxAge:o.expires_in,path:"/"}),o.refresh_token&&i.set("spotify_refresh_token",o.refresh_token,{maxAge:2592e3,path:"/"}),o.access_token}catch(e){return a("Error refreshing token",e),null}}},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6487:()=>{},6559:(e,t,r)=>{"use strict";e.exports=r(4870)},8335:()=>{},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[80,999],()=>r(317));module.exports=n})();